# ===============================
# .cursorrules — Non-negotiable
# ===============================

# 基本方針
- 言語: TypeScript。tsconfig は strict。any 禁止（Zod parse 直後の狭小化用途は例外可）。
- フレームワーク: Next.js(App Router)。
- UI: Tailwind CSS + shadcn/ui + lucide-react。行間1.4–1.6、44pxタップ最小（03/13, 01/4.1）。
- 状態管理: TanStack Query(サーバ状態) + Zustand(UI局所)。サーバ真実源をZustandに複写しない。
- フォーム/検証: React Hook Form + Zod（中央スキーマ管理）。
- 永続化: 編集中は IndexedDB(Dexie) にローカル保存。ナビゲーション境界/押下時のみサーバ保存（04, 06/5）。
- 用語/キー: 02_Dictionary_Master_v2 の英語キーに厳密準拠（例: warlord/skill/tactics）。
- パレットの同時表示: フリー1編成、共存性5編成（03/1.2）。UIビューステートはサーバに保存しない（06/2.6, 3.2.4 注）。
- OCR画像は保存しない（01/1.2）。必要最小の一時処理のみ。PIIログ禁止（01/4.4）。

# UI/操作
- スマホ縦中心のタップ操作で全機能が完結（03/0, 03/3, 03/13）。
- D&Dは補助。必ずタップ/キーボードで等価操作（03/3, 03/13）。
- ズーム/パンは 0.75/1.0/1.25 の3段階（MVP）。将来拡張は別PR（03/12.2）。

# アクセシビリティ
- コントラストAA、フォーカス可視、44pxターゲット、色依存NG（01/4.1, 03/13）。
- キー操作: Tab/矢印/Enter/Space、1/2/3でパレット切替 Tで所持トグル（03/13）。

# データ/型ポリシー
- Firestore: users/{userId}/(assets|compositions|workspace) サブコレクション（06/2.3）。
- 列挙: 06/3.3 の数値Enumに準拠。API層は ISO-8601 文字列化（07/2）。
- composition.slots[*] は 3枠固定のモデル（03/2, 06/3.2.3）。武将スワップ時は配下(skill/tactics/notes)も一括入替（03/2, 03/3）。
- workspace は UI配置ID群のみ保持。ズーム/パン等はローカルのみ（06/2.6, 3.2.4 注）。

# API規約
- バージョン: /api/v1（07/2）。
- master系 GET は public cache + SWR 推奨（07/3）。
- 更新系は expectedUpdatedAt を必須（409 on mismatch）（07/3 同時更新制御）。
- エラー形式は 07/6 に準拠（code/message/fields[]）。

# 計測/KPI
- 主要イベントは 03/12.5 & 04/6 に準拠（例: signup_complete, ocr_batch_start/done, assets_confirmed, composition_start, first_composition_save, export_*）。
- KPI 目標（01/3.2）を崩さない実装（TTOCR/TTC/TTFL）。

# セキュリティ
- 認証: Firebase Auth（Google主導線、匿名Auth併用）（01/4.2, 05/1）。
- RLS/Rulesで userId 隔離。CSP, HSTS, XFO, X-CTO, TLS1.2+（01/4.2）。
- レート制限は IP+User の二重。ログは構造化JSONで PII除外（01/4.4）。

# プロジェクト構造（推奨）
- app/(feature)/**: ページ/UI
- src/schema/**: Zod スキーマ（06* 準拠）
- src/repositories/**: Firestore/API アクセス
- src/stores/**: Zustand
- src/lib/**: firebase/env/dexie/logger/analytics
- data/master/**: マスターJSON（シード用）
- scripts/**: seed 等
- docs/**: 01..07 ドキュメント（章番号を見出しに残す）

# 命名規約
- ファイル/フォルダは kebab-case、型/コンポーネントは PascalCase、変数は camelCase。
- イベント名/キーは 02/英語キーに整合。UI表記は日本語でも、コードは英語キー優先。

# PR/変更境界
- 1タスク=1PR。UI・store・repoの越境は避ける。型変更は schema → 影響箇所をまとめて修正。
- 仕様根拠は章番号付きでコメント（例: // 参照: 03/2.1）。

# 禁止事項
- 直接 fetch で外部叩き。必ず repo 経由。
- ビジネスロジックをコンポーネントに同居。
- 用語不一致（02違反）。skill/tactics/warlord の混用。
- オンライン前提の保存（MVPはローカル常時保持が主）。
- 画像恒久保存（01/1.2に反する）。
