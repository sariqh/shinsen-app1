# 01_requirements.md
Last-Updated: 2025-09-25

## 1. プロダクト概要
- 名称：三国志真戦 編成アプリ（仮）
- 目的：
  - 編成作成支援：部隊・武将・戦法を効率よく組み合わせられるようにする → 編成作成の楽しみを最大化。
  - 資産管理：所有武将・戦法を可視化・整理 → コレクションや進捗の把握が容易に。
  - 編成依頼効率化：資産情報を仲間へ共有可能にする → 編成師への相談や依頼がスムーズに。
- 期待される体験：
  - 「編成を考える楽しみ」
  - 「収集・育成の進捗を俯瞰する喜び」
  - 「相談・依頼のやり取りが効率化される安心感」
- 成果物：Webアプリ（レスポンシブ）。将来的にPWA。
- 対応端末：スマホ/タブレット（iOS/Android）/PC
- 推奨ブラウザ：Safari/Chrome 最新2メジャー

### 1.1 編成作成支援（パレット方式）
- グリッド選択形式：武将や戦法はグリッド表示されたものから直感的にタップ選択、文字検索なし
- フィルタ：シーズン／レア度／兵種／凸数など
- UX：重複選択チェック。ロングタップで詳細情報表示、ドラッグ/入替対応
- マスタは初回一括取得→IndexedDBキャッシュ（オフライン可）

### 1.2 資産取り込み（OCR必須/MVP）
- スクリーンショットから 所持武将/凸数 を抽出（所持戦法はPhase 2）
- 画像前処理：傾き補正・コントラスト・ノイズ除去
- 候補+信頼度 を提示 → 校正UI で確認・修正 → `POST /api/v1/users/{userId}/assets（アップサート）` 反映
- フォールバック：CSV/JSONインポート（後追い）
- ローカル（ブラウザ内）処理が原則。HEICはクライアント変換（可能なら）／不可ならFunctions経由で変換。
- プライバシー：画像は一時処理のみ（保存しない）。保持が必要な場合は匿名化＋短期保持
- アップロード制約：
  - 運用で調整可能（サーバ設定化）
  - 初期値：
    - 最大20枚、5MB/枚・合計80MB、最小1080×1920
    - JPEG/PNG/HEIC（HEICはサーバ変換）、並列4
    - 処理バッチ管理指標として「スループット / バッチ滞留数 / バッチ処理完了時間」を計測対象とする
- 対応テンプレ：`warlord_list_v1`（武将一覧スクリーンショット）
> 本MVPはブラウザ内処理が原則。必要時のみ最小限のサーバ変換/補助を行う。処理指標はクライアント側の「処理スループット／バッチ滞留数／バッチ処理完了時間」を基本とする。

### 1.3 エクスポート
- 編成の 画像/CSV エクスポート（MVP最小）

> - 用語はマスター辞書（仕様/コード用）に準拠し、UI表記には使用しない
---

## 2. ターゲット
- ターゲット：アクティブ/初心者/編成師
- ユーザーストーリー例：
  - 所持武将と戦法を正確に把握したい（長期プレイで情報が散逸し、記憶が困難）→ 資産管理機能で一覧化。
  - 編成を何パターンも考えたいが、普段使っていない武将の存在を忘れたり、戦法との整合性を維持するのが難しい → 編成作成支援機能で保存・整合性チェック。
  - 編成師は相談を受けるが、相談者の所持リソースが把握できず、何度も確認する必要がある → 資産のエクスポート（画像/CSV）により正確なリソース把握が可能。

---

## 3. KPI
### 3.1 主要KPI
  - WAU/MAU、保存済み編成数、資産エクスポート回数（画像/CSV）、滞在時間。

### 3.2 MVP KPI
- TTOCR_batch（signup_complete→choose_B→ocr_batch_start→ocr_batch_done→assets_confirmed）:
  p50 ≤ 180s / p95 ≤ 600s
- TTC_composition（composition_start → first_composition_save）:
  p50 ≤ 300s / p95 ≤ 900s
- TTFL_app（app_landing→first_composition_save）:
  p50 ≤ 600s / p95 ≤ 1800s
- 到達率: choose_B→assets_confirmed ≥ 70%、assets_confirmed→first_composition_save ≥ 80%
- C→B誘導CVR: first_composition_save（C）→24h以内の assets_confirmed ≥ 30%
- 24h完了率（初回訪問→初保存）: ≥ 70%
> サインアップ直後の3ボタン
> A：「自分だけの武将図鑑を作成してみる」（アップロードのみ）“まずは図鑑を作って準備する”
> B（おすすめ）：「自分の手持ちを読み込ませて編成作成」“おすすめ：精度の高い候補・資産フィルタが使えます”
> C：「手持ちを読み込まずに編成作成」“お試し（あとで読み込み可）”
> > ログイベント例：`signup_complete`、`choose_A|choose_B|choose_C`、`ocr_batch_start/ocr_image_done/ocr_image_fail/ocr_batch_done/ocr_batch_fail`、`assets_confirmed`、`composition_start`、`palette_interact_first`、`first_composition_save`、`export_csv/image`
> 注：p50=中央値（50%がこの時間以内）、p95=95パーセンタイル（95%がこの時間以内）

### 3.3 品質KPI
  - LCP < 2.5s、主要操作 p95 < 500ms、クラッシュフリーセッション > 99%
  - OCR：主要武将50件で識別精度 > 95%、校正修正件数中央値 ≤ 3件/回

---

## 4. 非機能要件
### 4.1 アクセシビリティ
- 最小要件：コントラストAA/フォーカス可視/aria属性/キーボード操作（矢印・Space）/ドラッグ＆ドロップ
- モバイルのD&D代替：長押し→入替、または“入替モード”でタップ選択
- タップターゲットは最小44pxを確保

### 4.2 セキュリティ
- 認証：
  - OIDC（Google）を主導線。Firebase匿名Authをセカンド導線。
  - Appleは Hide My Email の利用を推奨（匿名性ニーズへの配慮）。
  - 取得スコープは最小限（メール/表示名）。SNSの友達情報・投稿は取得しない。
  - ログイン画面に取得項目を明示（透明性）。
- 認可：RBAC + RLS（既定の anonymous/user/admin 役割）。
- データ保護：保存時暗号化（DB/ストレージマネージド暗号化）、送信時 TLS1.2+、HSTS、HTTP→HTTPS 強制。
- ブラウザ対策：CSP（script-src 'self' など）、X-Frame-Options: DENY、X-Content-Type-Options: nosniff。
- 入力検証：API 層でスキーマ検証（例：Zod）。長文フィールドは長さ制限（例：notes ≤ 2000）。
- レート制限/Abuse：IP+Userの二重レート制限（例：/units POST 60/min）、失敗ログインの段階的遅延。
- 監査ログ：作成/更新/削除/公開状態変更/ロール変更を append-only で記録（who/when/what/before/after/trace_id）。
- 秘密情報管理：
  - Secrets は Secret Manager 管理、ローカルは .env.local。
  - JWT/DB/Redis のローテーション方針は 90d/90d/180d。

Magic Link の注意点（運用メモ）：配信遅延や迷惑メール振分けのUX低下、リンク有効期限（推奨 5–15 分）、捨てアド利用時の復旧不能に留意。メール配信は SPF/DKIM/DMARC を設定。

### 4.3 性能
- SLO（MVP）：主要API p95 < 500ms／ページ LCP < 2.5s（4G/中端）。
- キャッシュ：masters/bundle の ETag/If-None-Match + IndexedDB、画像はCDNキャッシュ（stale-while-revalidate）
- OCR運用：TTOCR_batch p50/p95・fail率・画像枚数/サイズ分布・推定コストを計測し、枚数/MB/並列/レートをRemote Configで随時更新。閾値超過時は自動で並列を絞り、必要なら一時的にC導線へ誘導する。

- アセット：サムネ webp 600w、遅延読み込み。バンドル上限 ~200KB（gzip）。

### 4.4 可観測性
MVPは Sentry＋最小限の構造化ログ。メトリクス/OTelは Phase 2
- ログ：JSON 構造化（ts,level,msg,service,trace_id,user_id?）。PIIは記録しない。
- ビジネス指標：保存済編成数/編成の保存回数/資産エクスポート回数（画像/CSV）/滞在時間。
- エラー監視：Sentry（Front/Back）。5xx > 1% が5分継続で通知。
- 保持：アプリログ30→90日集約、監査ログ1年。
- メトリクス：http_req_duration(p50/p95/p99), error_rate, cache_hit_ratio, DB query_time。（Phase 2〜）
- トレース：OpenTelemetry で分散トレース。trace_id をログと相互参照。（Phase 2〜）

### 4.5 可用性 / 拡張性
- SLA（内部目標）：稼働率 99.9%。/healthz 外形監視。
- DR：RPO 1h / RTO 4h。DB 1h スナップショット＋日次フル、月次復元演習。
- スケール：読み取りは Edge/リードレプリカ、書込みは楽観ロック＋リトライ（updated_at 比較）。
- 非同期：長処理はキュー（例：Queues）。冪等キー＋指数バックオフ＋DLQ。
- リリース：Blue-Green/Canary（1%→10%→100%）。前方互換マイグレーション（追加→デュアルライト→切替→削除）。
- Runbook：バランス改定パッチ登録/ロール付与/DB復元手順を整備。

### 4.6 テスト/品質ゲート（NFR検証）
- ユニット/コンポーネント/契約(API)/E2E（編成作成→保存→エクスポート（画像/CSV））。
- 負荷試験：選択グリッド表示API RPS100で p95 < 500ms、キャッシュミスでも p95 < 800ms。
- セキュリティ：RLS侵害テスト、OWASP ASVS Low–Mid の簡易チェック。
- CI ゲート：型/リンタ/脆弱性/SQL/マイグレーション差分検証。

---

## 5. スコープ/非スコープ
### 5.1 MVP（個人完結型／最短リリース）
- ✅ スコープ
  - 所持武将・戦法の登録/編集/削除（ローカル資産の管理）
  - 編成の作成/保存（自分の編成に限定）
  - OCRによる所持武将の登録
  - エクスポート：画像/CSV（外部共有はファイル渡し想定）
  - 認証：Google + 匿名Oath（Apple/Magic Link は Phase 2 以降で再検討）
  - 非機能：SLO（p95 API < 500ms）、最小の監査ログ、バックアップ手順
- 🚫 非スコープ（MVPではやらない）
  - OCRによる所持戦法の登録　
  - 公開編成・共有用URL生成・ランキング・コメント/いいね
  - 他ユーザー閲覧、フォロー、通知
  - 複雑なモデレーション、通報、凍結

### 5.2 Phase 2（限定ソーシャル）
- OCRによる所持戦法の登録　
- 公開フラグ（visibility=public|private|unlisted）
- 共有用短縮URLの発行
- 公開編成の検索/一覧（基本フィルタのみ）
- プレイヤープロフィール  
- いいね、コメントスレッド、編成投票とランキング
- 備考
  - RLS/RBAC本格化、監査ログの拡充
  - Redis：ホットクエリを TTL 60s、HIT率目標 60%。CRUD 時にタグ無効化。
  - DBクエリ予算：1リクエスト往復 ≤ 3、p95 < 50ms。N+1 検出、カーソルページング優先。

### 5.3 Phase 3（フルソーシャル）
- 未定

---

## 6. リスクと対策
- 従量課金の想定外増：日次コスト上限・バースト検知・一時制限（バッチ停止/並列縮小）で保護
- データ鮮度：三国志真戦アプリのアップデートの度に、必要に応じて運用担当者がマスタ更新を手動変更
- OCRロバスト性：テンプレ版管理（`warlord_list_v1`）、非対応はCSVへ誘導、前処理強化
- 端末差/解像度：画像要件をガイド、品質基準に満たない場合は弾く
- コスト：画像サイズ上限・回数制限、バッチ処理、必要ならエッジ実行
- 権利面：画像利用同意を明示、保存しない方針

