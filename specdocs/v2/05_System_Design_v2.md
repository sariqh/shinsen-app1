# 05\_System\_Design.md
Last-Updated: 2025-09-25

---

## 1. システム全体像
本システムは「三国志真戦 編成アプリ（仮）」のMVPにおける設計を対象とする。
フロントエンドはWebアプリ（レスポンシブ対応、将来的にPWA化）として提供し、バックエンドはクラウド上のAPI・DBを介してデータを保持・提供する。

### アーキテクチャ構成（MVP想定）
- フロントエンド：Next.js（Reactベース, TypeScript）, Tailwind CSS。
- UIライブラリ補助：shadcn/ui, lucide-react, framer-motion。
- 状態管理：TanStack Query（サーバ状態） + Zustand（UI局所状態）。
- フォーム/バリデーション：React Hook Form + Zod。
- クライアント保存：IndexedDB（Dexie） + （軽設定限定）LocalStorage。
- バックエンド/API：Firebase Functions。
- データベース：Firebase Firestore。
- 認証/認可：Firebase Authentication（匿名→必要時ログイン）。
- ホスティング：フロント=Vercel。バックエンドAPI=Firebase Cloud Functions（必要に応じ Hosting の rewrites で Functions を公開）。
- ストレージ：不要（MVPでは画像保存しない）。

---

## 2. コンポーネント設計
### 2.1 フロントエンド
- UI レイヤ：03\_UI\_Spec.md に準拠し、画面構成（編成作成・図鑑・資産共有など）を実装。
- ルーティング：Next.js のルーティング機能を利用し、04\_User\_Flows.md のユーザーフローを実現。
- ローカル保存：IndexedDB または LocalStorage による一時保存。
- サーバー自動同期タイミング：3.2参照。

### 2.2 バックエンド
- API層：フロントエンドからのリクエストを受け、Firestore へのCRUDを実行。
- サーバーレス設計：Firebase Functions を基盤に採用。

### 2.3 データベース
- Firestore 構成：NoSQL スキーマレス。
- 対象データ（MVP）：共有スナップ（編成の静的スナップショット）、ユーザーの図鑑データ、ユーザー設定の最小集合。
- 保存ポリシー：
  - ローカル保存：作業中データは基本的にローカル保存（Dexie）。
  - サーバー同期：3.2参照。
- 編成データは Firestore の users/{userId}/compositions/{compositionId} サブコレクションに保持する（トップレベル compositions は採用しない）。

### 2.4 認証/認可
- 方式：Firebase Authentication、Google認証。
- 利用方法：MVPではGoogle認証を優先。匿名認証でスタートしGoogle認証に促し。その他の認証方法は後追い。

### 2.5 編成作成UI（確定: SVG 採用）
- 目的：1枚キャンバス上でズーム/パン/ドラッグにより編成を直感的に編集・俯瞰。
- 描画方式：SVG。
- 主要ライブラリ：
  - ズーム/パン：`react-zoom-pan-pinch`
  - D&D：`dnd-kit`（カード/ノードの移動・スナップ）
  - UIローカル状態：`Zustand`（ビュー座標・選択状態）
  - アニメーション：`framer-motion`（スナップ/減衰）
  - 永続化（ローカル）：`Dexie`（IndexedDB、座標/倍率/パン位置の保存）
- 保存/同期：
  - レイアウト・ビューステート：ローカル保存が主（04_User_Flowsに準拠）。
  - サーバ同期トリガ：3.2参照。
- アクセシビリティ：SVG要素に `role` / `aria-label` / `tabIndex` を付与。キーボード移動も提供。
- パフォーマンス：
  - ノードコンポーネントの`memo`化、バッチ更新、可視範囲のみ描画（簡易カリング）。
  - 画像/アイコンはスプライト化。
- 将来拡張（提案）：要素数が600超でパフォーマンス課題が顕在化した場合、Canvasベース（react-konva）への移行を検討。

### 2.6 状態管理設計
- 役割分担：
  - サーバ状態：TanStack Query。取得/キャッシュ/再検証/ミューテーションを一元管理。
  - UI局所状態：Zustand。キャンバスのズーム倍率・パン座標・選択ID集合・ドラッグ中など高頻度更新を管理。
  - Context：依存注入・設定・クライアント共有など最小限。
- ルール：
  - サーバの真実源をZustandへ移さない（二重管理禁止）。
  - 書き込みはQueryのmutationに集約。
  - Zustandはselector活用＋ノード`memo`化で再レンダ抑制。
- ローカル永続：Dexieでノード/ビュー/編成を保持。ナビゲーション境界でFirestoreに同期。
- 将来拡張：
  - 大規模化・複雑な権限制御が必要になった場合は Redux Toolkit への移行を提案枠とする。
  - 同時編集が必要になった場合は CRDT（Yjs/Automerge）導入を検討。

### 2.7 OCR/画像解析設計
- 方式：ブラウザ内OCR（Tesseract.js）を採用。
- 対象：武将名テキスト、凸（limit_break）数、SPラベル。
- 処理フロー：
  - ROI切出し：各カードの武将名帯・凸帯を座標で切出し。
  - 前処理：canvas上でリサイズ、グレースケール、コントラスト強調、二値化。
  - OCR: Tesseract.js（`lang: jpn`）。辞書照合は武将名マスタ（02_Dictionary_Masterまたは別ドキュメント）を真実源として、厳格一致のみで判定。
  - 辞書照合：OCR結果を辞書で厳格一致→部分一致→距離計算で補正。不一致項目は未解決リストに格納し、ユーザーが図鑑で後から補正可能。
  - 凸数算出：凸領域を色抽出（HSVで青色/赤色判定）→連結成分数をカウント。複数枚所持しているカードも凸数加算。
  - SPラベル: 武将名左上の小領域を赤色抽出→(S2/S3/PK/SP/ラベル無し)の5通りからSP判定。
- 保存方針：抽出したテキスト/数値のみ保持。画像は保存しない。
- 性能想定：1画面12枚で0.8〜1.5秒（端末性能に依存）。
- HEIC 等の変換は可能な範囲でクライアント内で実施し、困難な場合に限り Functions 経由の最小限変換を用いる。
- 将来拡張（提案）：
  - 高精度が必要な場合、Firebase Functions経由で外部OCR（Google Vision等）にフォールバックする選択肢。
  - ラッソ選択や自動トリミングによるOCR対象領域自動検出。

---

## 3. データフロー
### 3.1 主要フロー
1. 図鑑操作：OCRによる一括登録。その後、ユーザーが所持武将/戦法を手動で更新 → ローカル保存。サーバー同期の詳細は3.2。
2. 編成作成：フロントエンドでリアルタイムに組み合わせを試行 → ローカル保存。サーバー同期の詳細は3.2。
3. 資産共有：図鑑データを他ユーザー向けに画像/CSVで共有。

### 3.2 データ同期（ローカル↔︎サーバー）
- トリガー：編成作成UIではユーザーによる保存操作。図鑑ではナビゲーション境界（MVP。将来的に条件増加可能性あり。）。
- 同期方式：Firestore とのバッチ書き込み。
- 競合回避：最後に保存されたスナップを正とする（タイムスタンプ降順）。MVPではサーバ優先。サーバ側の差分マージは後追い。

---

## 4. セキュリティ設計
- 認証：Firebase Authentication。
- 認可：Firestore Security Rules。
- 共有データ公開範囲：デフォルト非公開。ユーザー操作で共有ファイル発行。
- 通信：HTTPS 強制。

---

## 5. 非機能要件対応
- レスポンシブ対応：PC・スマホ両方対応。
- パフォーマンス：PWA化を見据え、オフラインキャッシュ（IndexedDB + Service Worker）を提案。
- 可観測性：後追いで 08\_Analytics\_Spec.md に準拠し、Firebase Analytics または GA4 を利用予定。
- コスト概算（開発+100人運用）：
  - Vercel: 無料〜約3,000円/月（Pro）。
  - Firebase Firestore/Auth/Functions/Hosting: 無料〜数百円程度。
  - 合計: 0〜1,000円程度/月、最大でも数千円/月。

---

## 6. 将来拡張の提案（MVP範囲外）
- Firestoreでの運用を基盤とする（確定）。
- トラフィック増や高度検索時は FastAPI + RDB への移行を検討。
- NoSQLで困難な集計ニーズが出た場合、Supabase(PostgreSQL) も選択肢（提案）。
- 差分同期・競合解決アルゴリズムの実装。
- 図鑑や編成の自動保存間隔設定。

---

## 7. 依存関係
- 確定仕様：01\_Requirements.md、02\_Dictionary\_Master、03\_UI\_Spec.md、04\_User\_Flows.md。
- 外部サービス：Firebase, Vercel。

---

## 8. 未決定事項
- サーバ同期の自動タイミング（ナビゲーション境界以外の契機を追加するか）。
- 高精度OCRの導入時期と方法（外部API利用）。

